<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checador Comida — DL (Multi-líneas)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  * { box-sizing: border-box; }
  html, body { height:100%; }
  body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0b1220; color:#e5e7eb; display:flex; flex-direction:column; }
  header { padding:14px 16px; background:#0f172a; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  header h1 { font-size:18px; margin:0; font-weight:700; }
  .pill { background:#1d4ed8; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:8px; }

  .wrap { flex:1; display:grid; place-items:center; padding:16px; }
  .card { width:min(1200px, 100%); background:#111827; border:1px solid #1f2937; border-radius:16px; padding:18px; }
  .prompt { font-size:22px; text-align:center; margin:6px 0 12px; color:#f3f4f6; }
  #inp { width:100%; font-size:26px; padding:12px 16px; border-radius:12px; border:1px solid #374151; background:#0b1220; color:#f9fafb; text-align:center; outline:none; letter-spacing:1px; }

  .status { margin-top:12px; padding:12px; border-radius:12px; text-align:center; font-size:16px; font-weight:700; display:none; }
  .ok { background:#052e1f; color:#a7f3d0; border:1px solid #065f46; }
  .err { background:#3b0d0d; color:#fecaca; border:1px solid #7f1d1d; }
  .muted { color:#9ca3af; font-size:12px; }

  .tools { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:2px 0; }
  .right{margin-left:auto}
  select, button, input[type="date"] {
    background:#1f2937; color:#e5e7eb; border:1px solid #374151; padding:8px 10px; border-radius:10px; cursor:pointer;
  }
  input[type="date"]{cursor:text}

  table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; border:1px solid #1f2937; margin-top:10px;}
  thead th{background:#0f172a; font-weight:700; text-align:left; font-size:14px; padding:10px}
  tbody td{border-top:1px dashed #1f2937; padding:9px 10px; font-size:15px; vertical-align:middle}
  .id{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .time{font-variant-numeric:tabular-nums; white-space:nowrap}
  .dur{font-variant-numeric:tabular-nums; font-weight:600}
  .flag{font-size:16px; line-height:1; color:#fbbf24; filter: drop-shadow(0 0 2px rgba(251,191,36,.5)); } /* ⚠️ */

  /* Charts al final */
  .charts { display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; margin-top:18px; }
  .chart-card { grid-column: span 12; background:#0f172a; border:1px solid #1f2937; border-radius:12px; padding:12px; }
  @media (min-width: 900px){
    .chart-card.sm-4 { grid-column: span 4; }
    .chart-card.sm-8 { grid-column: span 8; }
  }

  /* Separador visual */
  .divider { height:1px; background:#1f2937; margin:16px 0; border-radius:999px; }
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="Logo" style="height:40px">
  <h1>Checador DL — Comida <span class="pill">Salida / Regreso</span></h1>

  <div class="tools">
    <label for="line">Línea:</label>
    <select id="line"></select>
  </div>

  <div class="tools">
    <label for="fromDate">Desde:</label>
    <input id="fromDate" type="date"/>
    <label for="toDate">Hasta:</label>
    <input id="toDate" type="date"/>
    <button id="todayBtn">Hoy</button>
  </div>

  <div class="right tools">
    <button id="fs">Pantalla completa</button>
    <button id="export">Exportar CSV</button>
    <button id="refreshCharts">Actualizar gráficas</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <!-- 1) Escáner -->
    <div class="prompt">Escanea tu tarjeta o escribe tu ID y presiona Enter</div>
    <input id="inp" placeholder="Escanear aquí…" autocomplete="off" inputmode="numeric" />
    <div id="status" class="status"></div>

    <!-- 2) Historial (tabla) — queda arriba -->
    <table>
      <thead>
        <tr>
          <th style="width:120px">ID</th>
          <th>Nombre</th>
          <th style="width:160px">Salida</th>
          <th style="width:160px">Regreso</th>
          <th style="width:140px">Duración</th>
          <th style="width:110px">Fecha</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="muted" id="loader"></div>
    <div class="muted">Se sincroniza cada 2 segundos con <code>data.json</code>. Las <b>gráficas</b> se actualizan únicamente al presionar <i>Actualizar gráficas</i>.</div>

    <div class="divider"></div>

    <!-- 3) Gráficas — siempre hasta abajo -->
    <div class="charts">
      <div class="chart-card sm-4">
        <canvas id="chartBuckets"></canvas>
      </div>
      <div class="chart-card sm-8">
        <canvas id="chartCompliance"></canvas>
      </div>
      <div class="chart-card">
        <canvas id="chartAvg"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
/*** CONFIG ***/
const WORKER_URL   = "https://checador.montoyacarrillojesus6.workers.dev/";
const DATA_URL     = "https://raw.githubusercontent.com/jesus578m/checador/main/data.json";
const CATALOGO_URL = "catalogo.json";
const REMEMBER_LINE_KEY = "dlc:lastLine";
const REMEMBER_FROM_KEY = "dlc:fromDate";
const REMEMBER_TO_KEY   = "dlc:toDate";
const LINES = Array.from({length:12}, (_,i)=>`DL${i+1}`);
const MAX_OK = 70; // alerta sólo si >70

/*** UI refs ***/
const selline   = document.getElementById("line");
const fromDate  = document.getElementById("fromDate");
const toDate    = document.getElementById("toDate");
const todayBtn  = document.getElementById("todayBtn");
const inp       = document.getElementById("inp");
const statusBox = document.getElementById("status");
const loader    = document.getElementById("loader");
const btnFS     = document.getElementById("fs");
const btnExport = document.getElementById("export");
const btnRefreshCharts = document.getElementById("refreshCharts");
const tbody     = document.getElementById("tbody");

/*** State ***/
let catalog = [];
let byId = new Map();
let sessions = [];      // para la tabla (se actualiza cada 2s)
let rawData = [];
let pollTimer = null;

// charts
let chartBuckets, chartCompliance, chartAvg;
let chartsFrozenData = null; // “foto” de los datos que alimentan las gráficas

/*** Utils ***/
const pad = n => String(n).padStart(2,"0");
const todayISO = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
};
function setStatus(ok, msg) {
  statusBox.className = "status " + (ok ? "ok" : "err");
  statusBox.textContent = msg;
  statusBox.style.display = "block";
  clearTimeout(setStatus._t);
  setStatus._t = setTimeout(()=>statusBox.style.display="none", 3500);
}
function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
function fmtTime(ts){
  if (!ts) return "";
  const d = new Date(ts);
  if (isNaN(d)) return "";
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
}
function dateOf(ts){
  const d = new Date(ts);
  if (isNaN(d)) return null;
  return d.toISOString().slice(0,10);
}
function minsBetween(a,b){ if(!a||!b) return null; return Math.round((new Date(b)-new Date(a))/60000); }
function hm(mins){ if(mins==null) return ""; return `${pad(Math.floor(mins/60))}:${pad(mins%60)}`; }

/*** Boot ***/
init();
async function init(){
  // selects
  selline.innerHTML = LINES.map(l=>`<option value="${l}">${l}</option>`).join("");
  selline.value = localStorage.getItem(REMEMBER_LINE_KEY) || LINES[0];
  fromDate.value = localStorage.getItem(REMEMBER_FROM_KEY) || todayISO();
  toDate.value   = localStorage.getItem(REMEMBER_TO_KEY)   || todayISO();

  // cambios en filtros NO tocan las gráficas automáticamente
  selline.addEventListener("change", ()=>{ localStorage.setItem(REMEMBER_LINE_KEY, selline.value); applyFiltersForTableOnly(); });
  fromDate.addEventListener("change", ()=>{ localStorage.setItem(REMEMBER_FROM_KEY, fromDate.value); applyFiltersForTableOnly(); });
  toDate.addEventListener("change",   ()=>{ localStorage.setItem(REMEMBER_TO_KEY,   toDate.value);   applyFiltersForTableOnly(); });

  todayBtn.addEventListener("click", ()=>{
    const t = todayISO();
    fromDate.value = t; toDate.value = t;
    localStorage.setItem(REMEMBER_FROM_KEY, t);
    localStorage.setItem(REMEMBER_TO_KEY, t);
    applyFiltersForTableOnly();
  });

  btnFS.addEventListener("click", () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  });
  btnExport.addEventListener("click", downloadCSV);
  btnRefreshCharts.addEventListener("click", () => {
    // congelamos las gráficas con la foto actual de sesiones
    chartsFrozenData = sessions.slice();
    drawChartsFrom(chartsFrozenData);
    setStatus(true, "Gráficas actualizadas");
  });

  // catálogo
  await loadCatalog();

  // primera carga + polling (sólo tabla)
  await refresh();
  pollTimer = setInterval(refresh, 2000);

  // input escaneo
  inp.addEventListener("keydown", (ev)=>{
    if(ev.key==="Enter"){
      const raw=(inp.value||"").trim(); inp.value="";
      if(raw) handleScan(raw);
    }
  });
  inp.focus();
}

/*** Catalog loader ***/
async function loadCatalog(){
  loader.textContent="Cargando catálogo…";
  try{
    const res=await fetch(CATALOGO_URL,{cache:"no-store"});
    const arr=await res.json();
    catalog=(Array.isArray(arr)?arr:[]).map(x=>({
      employee_id:String(x.CREDENCIAL||x.employee_id||"").trim(),
      name:String(x.NOMBRE_COMPLETO||x.name||"").trim()
    })).filter(p=>p.employee_id&&p.name);
    byId.clear(); for(const p of catalog) byId.set(p.employee_id,{name:p.name});
    loader.textContent=`Catálogo cargado: ${catalog.length} empleados.`; setTimeout(()=>loader.textContent="",2000);
  }catch(e){ loader.textContent="Error al cargar catálogo."; }
}

/*** Data refresh (para la TABLA) ***/
async function refresh(){
  try{
    const res=await fetch(DATA_URL+"?t="+Date.now(),{cache:"no-store"});
    rawData=await res.json();
    applyFiltersForTableOnly();
  }catch(e){ setStatus(false,"No se pudo leer data.json"); }
}

function applyFiltersForTableOnly(){
  sessions = buildSessions(rawData, selline.value, fromDate.value, toDate.value);
  renderTable();
  // Importante: NO tocamos las gráficas aquí
}

/*** Build sessions (múltiples por empleado/día) ***/
function buildSessions(raw,line,from,to){
  const result=[];
  if(!Array.isArray(raw)) return result;

  // Consolidado directo (si existiera)
  for(const r of raw){
    if(r && r.date && r.linea && r.employee_id){
      if(r.linea!==line) continue;
      if(r.date<from || r.date>to) continue;
      const id=String(r.employee_id);
      const name=String(r.name || byId.get(id)?.name || "");
      const out  = r.out  || r.salida_comida || r.salida || null;
      const back = r.back || r.regreso_comida || r.regreso || null;
      result.push({date:r.date, linea:line, employee_id:id, name, out, back});
    }
  }

  // Por evento
  const bucket=new Map(); // key: d|line|id
  for(const r of raw){
    if(!(r && r.timestamp && r.linea && r.employee_id && r.evento)) continue;
    if(r.linea!==line) continue;
    const dISO=dateOf(r.timestamp); if(!dISO) continue;
    if(dISO<from || dISO>to) continue;
    const key=`${dISO}|${line}|${r.employee_id}`;
    if(!bucket.has(key)) bucket.set(key,[]);
    bucket.get(key).push(r);
  }
  for(const [key, arr] of bucket.entries()){
    arr.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
    const [d, ln, id] = key.split("|");
    let lastOut=null, lastName="";
    for(const ev of arr){
      const type=String(ev.evento).toLowerCase();
      const name = String(ev.nombre || ev.name || byId.get(id)?.name || "");
      lastName=name || lastName;
      if(type==="salida"){
        if(lastOut){ result.push({date:d, linea:ln, employee_id:id, name:lastName, out:lastOut, back:null}); }
        lastOut=ev.timestamp;
      }else if(type==="regreso"){
        if(lastOut){
          result.push({date:d, linea:ln, employee_id:id, name:lastName, out:lastOut, back:ev.timestamp});
          lastOut=null;
        }else{
          result.push({date:d, linea:ln, employee_id:id, name:lastName, out:null, back:ev.timestamp});
        }
      }
    }
    if(lastOut){
      result.push({date:d, linea:ln, employee_id:id, name:lastName, out:lastOut, back:null});
    }
  }

  // ordenar por fecha desc, hora desc
  result.sort((a,b)=>{
    if(a.date!==b.date) return a.date<b.date?1:-1;
    const ta=a.out||a.back||"", tb=b.out||b.back||"";
    return ta<tb?1:-1;
  });
  return result;
}

/*** Render tabla ***/
function renderTable(){
  const rows=sessions;
  if(!rows.length){
    tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;opacity:.7">Sin registros para el rango seleccionado.</td></tr>`;
    return;
  }
  tbody.innerHTML=rows.map(r=>{
    const mins=minsBetween(r.out,r.back);
    const warn = (mins!=null && mins>MAX_OK) ? ` <span class="flag" title="> ${MAX_OK} min">⚠️</span>` : "";
    return `
      <tr>
        <td class="id">${esc(r.employee_id)}</td>
        <td>${esc(r.name||"")}</td>
        <td class="time">${r.out?fmtTime(r.out):""}</td>
        <td class="time">${r.back?fmtTime(r.back):""}</td>
        <td class="dur">${mins!=null?hm(mins):""}${warn}</td>
        <td>${esc(r.date)}</td>
      </tr>`;
  }).join("");
}

/*** Charts (sólo al presionar “Actualizar gráficas”) ***/
function drawChartsFrom(rows){
  // buckets globales
  let ok=0, tol=0, over=0, inc=0;
  const dayStats = new Map(); // date -> { total, ok(≤70), over(>70), inc, avgDurSum, avgCount }

  for(const r of rows){
    const d=r.date;
    const mins=minsBetween(r.out,r.back);
    if(!dayStats.has(d)) dayStats.set(d, {total:0, ok:0, over:0, inc:0, avgDurSum:0, avgCount:0});
    const ds=dayStats.get(d);
    ds.total++;

    if(mins==null){ inc++; ds.inc++; }
    else if(mins<=MAX_OK){ ok++; ds.ok++; ds.avgDurSum+=mins; ds.avgCount++; }
    else { over++; ds.over++; ds.avgDurSum+=mins; ds.avgCount++; }
  }

  // Chart 1: Buckets
  const bucketsData = {
    labels: ["≤ 70 min", "> 70 min", "Incompletas"],
    datasets: [{ data: [ok, over, inc] }]
  };
  if(chartBuckets){ chartBuckets.data=bucketsData; chartBuckets.update(); }
  else {
    chartBuckets = new Chart(document.getElementById("chartBuckets"), {
      type: "doughnut",
      data: bucketsData,
      options: {
        plugins:{ legend:{ position:"bottom", labels:{ color:"#e5e7eb" }}, title:{display:true, text:"Distribución de sesiones", color:"#e5e7eb"}},
      }
    });
  }

  // Chart 2: % Cumplimiento por día
  const days = Array.from(dayStats.keys()).sort();
  const pct = days.map(d=>{
    const ds=dayStats.get(d);
    return ds.total ? Math.round(ds.ok*100/ds.total) : 0;
  });
  const complianceData = {
    labels: days,
    datasets: [{ label: "% Cumplimiento (≤70 min)", data: pct }]
  };
  if(chartCompliance){ chartCompliance.data=complianceData; chartCompliance.update(); }
  else {
    chartCompliance = new Chart(document.getElementById("chartCompliance"), {
      type: "bar",
      data: complianceData,
      options: {
        scales:{ x:{ ticks:{ color:"#e5e7eb"} }, y:{ ticks:{ color:"#e5e7eb"}, suggestedMin:0, suggestedMax:100 }},
        plugins:{ legend:{ labels:{ color:"#e5e7eb"}}, title:{display:true, text:`Cumplimiento por día — ${selline.value}`, color:"#e5e7eb"}}
      }
    });
  }

  // Chart 3: Promedio por día
  const avg = days.map(d=>{
    const ds=dayStats.get(d);
    return ds.avgCount? Math.round(ds.avgDurSum/ds.avgCount) : null;
  });
  const avgData = {
    labels: days,
    datasets: [{ label: "Duración promedio (min)", data: avg, tension:.2 }]
  };
  if(chartAvg){ chartAvg.data=avgData; chartAvg.update(); }
  else {
    chartAvg = new Chart(document.getElementById("chartAvg"), {
      type: "line",
      data: avgData,
      options: {
        scales:{ x:{ ticks:{ color:"#e5e7eb"} }, y:{ ticks:{ color:"#e5e7eb"} } },
        plugins:{ legend:{ labels:{ color:"#e5e7eb"}}, title:{display:true, text:`Promedio de duración — ${selline.value}`, color:"#e5e7eb"}}
      }
    });
  }
}

/*** Scan handler ***/
async function handleScan(rawId){
  const id=String(rawId).replace(/\D+/g,"");
  if(!id) return setStatus(false,"ID inválido");
  const found=byId.get(id);
  if(!found) return setStatus(false,`No se encontró ${id}`);
  const linea=selline.value;
  const t=todayISO();

  // últimos de hoy para decidir evento
  const todaySessions=buildSessions(rawData,linea,t,t).filter(s=>s.employee_id===id);
  let next="salida";
  if(todaySessions.length && todaySessions[0].out && !todaySessions[0].back) next="regreso";

  const record={linea,employee_id:id,nombre:found.name,evento:next,timestamp:new Date().toISOString()};
  try{
    const put=await fetch(WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"append",record})});
    if(!put.ok) throw new Error();
    setStatus(true,`${next.toUpperCase()} — ${found.name} (${id})`);
    if(fromDate.value!==t||toDate.value!==t){ fromDate.value=t; toDate.value=t; }
    await refresh(); // sólo tabla
  }catch(e){ setStatus(false,"No se pudo guardar"); }
}

/*** CSV ***/
function downloadCSV(){
  if(!sessions.length) return setStatus(false,"No hay datos");
  const head=["fecha","linea","employee_id","nombre","salida","regreso","duracion_min"];
  const lines=[head.join(",")];
  for(const r of sessions){
    const mins=minsBetween(r.out,r.back);
    lines.push([r.date,selline.value,r.employee_id,`"${String(r.name||"").replace(/"/g,'""')}"`,r.out||"",r.back||"",mins!=null?mins:""].join(","));
  }
  const blob=new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=`checador_${selline.value}_${fromDate.value}_a_${toDate.value}.csv`; a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>




