<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checador Comida — DL (Multi-líneas)</title>
<style>
  * { box-sizing: border-box; }
  html, body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b1220; color:#e5e7eb; display:flex; flex-direction:column; }
  header { padding:14px 16px; background:#0f172a; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  header h1 { font-size:18px; margin:0; font-weight:700; }
  .pill { background:#1d4ed8; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:8px; }
  .wrap { flex:1; display:grid; place-items:center; padding:16px; }
  .card { width:min(860px, 100%); background:#111827; border:1px solid #1f2937; border-radius:16px; padding:18px; }
  .topbar { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:10px; }
  .group { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  select, button { background:#1f2937; color:#e5e7eb; border:1px solid #374151; padding:8px 12px; border-radius:10px; cursor:pointer; }
  .prompt { font-size:24px; text-align:center; margin:10px 0 16px; color:#f3f4f6; }
  #inp { width:100%; font-size:28px; padding:14px 16px; border-radius:12px; border:1px solid #374151; background:#0b1220; color:#f9fafb; text-align:center; outline:none; letter-spacing:1px; }
  .status { margin-top:16px; padding:16px; border-radius:12px; text-align:center; font-size:20px; font-weight:700; display:none; }
  .ok { background:#052e1f; color:#a7f3d0; border:1px solid #065f46; }
  .err { background:#3b0d0d; color:#fecaca; border:1px solid #7f1d1d; }
  .list { margin-top:14px; background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:10px; max-height:320px; overflow:auto; }
  .row { display:grid; grid-template-columns: 92px 1fr 130px 64px; align-items:center; gap:8px; padding:6px 4px; border-bottom:1px dashed #1f2937; font-size:14px; }
  .row:last-child { border-bottom: none; }
  .id { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  .logo { height:40px; }
  .muted { color:#9ca3af; font-size:12px; }
</style>
</head>
<body>
<header>
  <img src="logo.png" class="logo" alt="Logo">
  <h1>Checador DL — Comida <span class="pill">Salida / Regreso</span></h1>
  <div style="margin-left:auto;" class="group">
    <label for="line">Línea:</label>
    <select id="line"></select>
    <button id="fs">Pantalla completa</button>
    <button id="export">Exportar CSV</button>
    <button id="clearToday">Borrar hoy</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="prompt">Escanea tu tarjeta o escribe tu ID y presiona Enter</div>
    <input id="inp" placeholder="Escanear aquí…" autocomplete="off" inputmode="numeric" />
    <div id="status" class="status"></div>
    <div class="list" id="recent"></div>
    <div class="muted" id="loader"></div>
  </div>
</div>

<script>
/*** CONFIG ***/
const WORKER_URL = "https://checador.montoyacarrillojesus6.workers.dev/"; // <-- cambia si usas otro
const CATALOGO_URL = "catalogo.json"; // Debe existir en la misma carpeta
const REMEMBER_LINE_KEY = "dlc:lastLine";
const LAST_EVENT_KEY_PREFIX = "dlc:lastEvent:"; // se concatena YYYY-MM-DD
const RECENTS_KEY_PREFIX   = "dlc:recents:";    // se concatena YYYY-MM-DD
const LINES = Array.from({length:12}, (_,i)=>`DL${i+1}`);

/*** UI refs ***/
const selline = document.getElementById("line");
const inp = document.getElementById("inp");
const statusBox = document.getElementById("status");
const recentBox = document.getElementById("recent");
const btnFS = document.getElementById("fs");
const btnExport = document.getElementById("export");
const btnClear = document.getElementById("clearToday");
const loader = document.getElementById("loader");

/*** State ***/
let catalog = [];
let byId = new Map(); // id -> {name}
let recent = [];      // registros de hoy (vista)
let lastEvent = {};   // { employee_id: "salida"|"regreso" }

/*** Utils ***/
const todayKey = () => new Date().toISOString().slice(0,10);
const getLastEventKey = () => LAST_EVENT_KEY_PREFIX + todayKey();
const getRecentsKey   = () => RECENTS_KEY_PREFIX + todayKey();

function setStatus(ok, msg) {
  statusBox.className = "status " + (ok ? "ok" : "err");
  statusBox.textContent = msg;
  statusBox.style.display = "block";
  setTimeout(()=>statusBox.style.display="none", 3500);
}

function saveLocalState() {
  localStorage.setItem(getLastEventKey(), JSON.stringify(lastEvent));
  localStorage.setItem(getRecentsKey(), JSON.stringify(recent));
}

function loadLocalState() {
  try {
    lastEvent = JSON.parse(localStorage.getItem(getLastEventKey()) || "{}");
  } catch { lastEvent = {}; }
  try {
    recent = JSON.parse(localStorage.getItem(getRecentsKey()) || "[]");
  } catch { recent = []; }
}

function renderRecent() {
  recentBox.innerHTML = "";
  if (!recent.length) {
    recentBox.innerHTML = `<div class="muted" style="padding:8px;">Sin registros hoy.</div>`;
    return;
  }
  for (const r of recent.slice().reverse()) {
    const row = document.createElement("div");
    row.className = "row";
    const hhmm = new Date(r.timestamp).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    row.innerHTML = `
      <div class="muted">${hhmm}</div>
      <div><span class="id">${r.employee_id}</span> — ${r.nombre}</div>
      <div>${r.evento.toUpperCase()}</div>
      <div>${r.linea}</div>
    `;
    recentBox.appendChild(row);
  }
}

function toCSV(rows) {
  const header = ["fecha","hora","linea","employee_id","nombre","evento","timestamp"];
  const lines = [header.join(",")];
  for (const r of rows) {
    const d = new Date(r.timestamp);
    const fecha = d.toISOString().slice(0,10);
    const hora = d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    const row = [
      fecha,
      hora,
      r.linea,
      `"${(r.employee_id||"").replace(/"/g,'""')}"`,
      `"${(r.nombre||"").replace(/"/g,'""')}"`,
      r.evento,
      r.timestamp
    ];
    lines.push(row.join(","));
  }
  return lines.join("\n");
}

function download(filename, text) {
  const blob = new Blob([text], {type: "text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/*** Boot ***/
(function init() {
  // líneas
  selline.innerHTML = LINES.map(l=>`<option value="${l}">${l}</option>`).join("");
  const remembered = localStorage.getItem(REMEMBER_LINE_KEY);
  if (remembered && LINES.includes(remembered)) selline.value = remembered;
  else selline.value = LINES[0];
  selline.addEventListener("change", () => {
    localStorage.setItem(REMEMBER_LINE_KEY, selline.value);
    inp.focus();
  });

  // eventos UI
  btnFS.addEventListener("click", () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  });

  btnExport.addEventListener("click", () => {
    if (!recent.length) { setStatus(false, "No hay registros para exportar"); return; }
    const name = `checador_${todayKey()}.csv`;
    download(name, toCSV(recent));
  });

  btnClear.addEventListener("click", () => {
    if (!confirm("¿Borrar registros locales de HOY? (No borra GitHub)")) return;
    recent = [];
    lastEvent = {};
    saveLocalState();
    renderRecent();
    setStatus(true, "Registros locales borrados");
  });

  // cargar estado local
  loadLocalState();
  renderRecent();

  // cargar catálogo
  loadCatalog().then(()=>{
    loader.textContent = `Catálogo cargado: ${catalog.length} empleados.`;
    setTimeout(()=>loader.textContent="", 3000);
  }).catch(err=>{
    console.error(err);
    loader.textContent = "No se pudo cargar el catálogo.";
    setStatus(false, "Error al cargar catálogo");
  });

  // manejar escaneo/enter
  inp.addEventListener("keydown", (ev)=>{
    if (ev.key === "Enter") {
      const raw = (inp.value || "").trim();
      inp.value = "";
      if (!raw) return;
      handleScan(raw);
    }
  });

  inp.focus();
})();

/*** Catalog loader ***/
async function loadCatalog() {
  const res = await fetch(CATALOGO_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("HTTP "+res.status);
  const data = await res.json(); // [{CREDENCIAL:123, NOMBRE_COMPLETO:"..."}]
  catalog = Array.isArray(data) ? data : [];
  byId.clear();
  for (const p of catalog) {
    const id = String(p.CREDENCIAL ?? p.employee_id ?? "").trim();
    const name = String(p.NOMBRE_COMPLETO ?? p.name ?? "").trim();
    if (id) byId.set(id, { name });
  }
}

/*** Main handler ***/
async function handleScan(rawId) {
  const id = String(rawId).replace(/\D+/g,""); // deja solo dígitos
  if (!id) { setStatus(false, "ID inválido"); return; }

  const found = byId.get(id);
  if (!found) { setStatus(false, `No se encontró el ID ${id}`); return; }

  const nombre = found.name || "SIN NOMBRE";
  const linea = selline.value;
  const last = lastEvent[id] || null;
  const nextEvento = (last === "salida") ? "regreso" : "salida";
  const ts = new Date().toISOString();

  const record = { linea, employee_id: id, nombre, evento: nextEvento, timestamp: ts };

  try {
    const put = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "append", record })
    });
    const ok = put.ok;
    // opcional: const body = await put.text();
    if (!ok) throw new Error("Worker respondió: "+put.status);

    // Éxito -> actualiza locales
    lastEvent[id] = nextEvento;
    recent.push(record);
    saveLocalState();
    renderRecent();

    setStatus(true, `${nextEvento.toUpperCase()} — ${nombre} (${id})`);
  } catch (err) {
    console.error(err);
    setStatus(false, "No se pudo guardar. Reintenta.");
  }
}
</script>
</body>
</html>

