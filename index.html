<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checador Comida — DL (Multi-líneas)</title>
<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:#0b1220; color:#e5e7eb;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:flex; flex-direction:column;
  }
  header{background:#0f172a; padding:12px 16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  header h1{margin:0; font-size:18px; font-weight:700}
  .pill{background:#1d4ed8; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:8px}
  .wrap{flex:1; padding:16px; display:grid; place-items:start}
  .card{width:min(1200px,100%); margin:auto; background:#111827; border:1px solid #1f2937; border-radius:14px; padding:18px}
  .topbar{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:10px; flex-wrap:wrap}
  .group{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  label{font-size:14px; opacity:.85}
  select,button{
    background:#1f2937; color:#e5e7eb; border:1px solid #374151;
    padding:8px 12px; border-radius:10px; cursor:pointer
  }
  #inp{
    width:100%; font-size:28px; padding:14px 16px; border-radius:12px;
    border:1px solid #374151; background:#0b1220; color:#f9fafb; outline:none;
    text-align:center; margin:8px 0 12px
  }
  .status{margin:8px 0 6px; padding:12px; border-radius:10px; font-weight:700; text-align:center; display:none}
  .ok{background:#052e1f; color:#a7f3d0; border:1px solid #065f46}
  .err{background:#3b0d0d; color:#fecaca; border:1px solid #7f1d1d}
  .hint{font-size:12px; opacity:.7; margin-top:8px}
  table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:10px; border:1px solid #1f2937}
  thead th{background:#0f172a; font-weight:700; text-align:left; font-size:14px; padding:10px}
  tbody td{border-top:1px dashed #1f2937; padding:10px; font-size:15px}
  .id{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .time{font-variant-numeric:tabular-nums}
  .right{margin-left:auto}
</style>
</head>
<body>
  <header>
    <h1>Checador DL — Comida <span class="pill">Salida / Regreso</span></h1>
    <div class="right group" style="margin-left:auto">
      <label for="line">Línea:</label>
      <select id="line"></select>
      <button id="btnExport">Exportar CSV</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="topbar" style="justify-content:center; width:100%">
        <h2 style="margin:0; font-size:20px; font-weight:600; opacity:.9">
          Escanea tu tarjeta o escribe tu ID y presiona Enter
        </h2>
      </div>

      <input id="inp" placeholder="Escanear aquí…" autocomplete="off" />

      <div id="status" class="status"></div>

      <table>
        <thead>
          <tr>
            <th style="width:120px">ID</th>
            <th>Nombre</th>
            <th style="width:140px">Salida</th>
            <th style="width:140px">Regreso</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="hint">Se actualiza cada 5 segundos. Lo que ves es lo que está en <code>data.json</code>.</div>
    </div>
  </div>

<script>
/*** CONFIG ***/
const WORKER_URL  = "https://checador.montoyacarrillojesus6.workers.dev/"; // tu Worker
// data.json directo del repo (ajusta si cambias owner/branch/repo)
const DATA_URL    = "https://raw.githubusercontent.com/jesus578m/checador/main/data.json";
const CATALOGO_URL = "catalogo.json"; // Debe existir en la misma carpeta
const REMEMBER_LINE_KEY = "dlc:lastLine";
const LINES = Array.from({length:12}, (_,i)=>`DL${i+1}`);

/*** UI refs ***/
const lineSel = document.getElementById("line");
const inp = document.getElementById("inp");
const tbody = document.getElementById("tbody");
const statusBox = document.getElementById("status");
const btnExport = document.getElementById("btnExport");

/*** STATE ***/
let catalog = [];  // [{employee_id,name}]
let data = [];     // contenido de data.json (array de filas consolidadas)
let selectedLine = localStorage.getItem(REMEMBER_LINE_KEY) || "DL1";
let refreshTimer = null;

/*** INIT ***/
init();
async function init() {
  // líneas
  lineSel.innerHTML = LINES.map(l=>`<option value="${l}">${l}</option>`).join("");
  lineSel.value = selectedLine;
  lineSel.addEventListener("change", () => {
    selectedLine = lineSel.value;
    localStorage.setItem(REMEMBER_LINE_KEY, selectedLine);
    render();
  });

  // carga inicial
  await loadCatalog();
  await refresh();

  // polling
  refreshTimer = setInterval(refresh, 5000);
}

// Cargar catálogo y normalizar
async function loadCatalog() {
  try {
    const res = await fetch(CATALOGO_URL, { cache: "no-store" });
    const raw = await res.json();
    catalog = (Array.isArray(raw) ? raw : []).map(x => ({
      employee_id: String(x.employee_id ?? x.CREDENCIAL ?? x.credencial ?? "").trim(),
      name: String(x.name ?? x.NOMBRE_COMPLETO ?? "").trim(),
    })).filter(p => p.employee_id && p.name);
    console.log("Catálogo cargado:", catalog.length, "personas");
  } catch (e) {
    console.error("No se pudo cargar catalogo.json", e);
    showStatus("Error cargando catalogo.json", false);
  }
}

// Traer data.json del repo (para que todos vean en vivo)
async function refresh() {
  try {
    const res = await fetch(DATA_URL + "?_=" + Date.now(), { cache: "no-store" });
    // En caso de repo vacío, intenta parsear texto
    const txt = await res.text();
    data = JSON.parse(txt || "[]");
    render();
  } catch (e) {
    console.error("No se pudo leer data.json", e);
    showStatus("No se pudo leer data.json", false);
  }
}

// Escucha de Enter en el input
inp.addEventListener("keydown", async (e) => {
  if (e.key !== "Enter") return;
  const raw = inp.value.trim();
  if (!raw) return;

  const person = findPersonByScan(raw);
  if (!person) {
    showStatus(`ID "${raw}" no encontrado en catálogo`, false);
    inp.select();
    return;
  }

  const today = new Date().toISOString().slice(0,10);
  const existing = (data || []).find(r =>
    r.date === today &&
    r.linea === selectedLine &&
    String(r.employee_id) === String(person.employee_id)
  );
  const nextMark = !existing?.out ? "out" : (!existing?.back ? "back" : "out");

  showStatus(`${person.name} → ${nextMark === 'out' ? 'SALIDA' : 'REGRESO'}`, true);

  const body = {
    action: "append",
    record: {
      date: today,
      linea: selectedLine,
      employee_id: person.employee_id,
      name: person.name,
      mark: nextMark
    }
  };

  try {
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    const j = await res.json().catch(()=>({ok:false}));
    if (j && j.ok) {
      inp.value = "";
      await refresh();
    } else {
      console.warn("Respuesta worker", j);
      showStatus("No se pudo guardar (Worker no OK)", false);
    }
  } catch (err) {
    console.error(err);
    showStatus("Error de red al guardar", false);
  }
});

// Encontrar persona por escaneo (solo dígitos)
function findPersonByScan(scan) {
  const id = String(scan).replace(/\D/g, "");
  if (!id) return null;
  return catalog.find(p => p.employee_id === id) || null;
}

// Render de tabla (hoy + línea seleccionada)
function render() {
  const today = new Date().toISOString().slice(0,10);
  const rows = (Array.isArray(data)?data:[])
    .filter(r => r.date === today && r.linea === selectedLine)
    .sort((a,b) => (a.name||"").localeCompare(b.name||""));

  tbody.innerHTML = rows.map(r => {
    const out = r.out ? fmtTime(r.out) : "";
    const back = r.back ? fmtTime(r.back) : "";
    return `<tr>
      <td class="id">${escapeHtml(r.employee_id)}</td>
      <td>${escapeHtml(r.name||"")}</td>
      <td class="time">${out}</td>
      <td class="time">${back}</td>
    </tr>`;
  }).join("");

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="4" style="opacity:.7; text-align:center; padding:14px">
      No hay registros para hoy en <b>${escapeHtml(selectedLine)}</b>.
    </td></tr>`;
  }
}

// Exportar CSV de lo que ves
btnExport.addEventListener("click", () => {
  const today = new Date().toISOString().slice(0,10);
  const rows = (Array.isArray(data)?data:[])
    .filter(r => r.date === today && r.linea === selectedLine)
    .sort((a,b) => (a.name||"").localeCompare(b.name||""));

  const head = ["Fecha","Línea","ID","Nombre","Salida","Regreso"];
  const body = rows.map(r => [
    r.date, r.linea, r.employee_id, r.name,
    r.out ? fmtTime(r.out) : "", r.back ? fmtTime(r.back) : ""
  ]);
  const csv = [head, ...body].map(row =>
    row.map(v => `"${String(v??"").replace(/"/g,'""')}"`).join(",")
  ).join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `checador_${today}_${selectedLine}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

// Utils
function fmtTime(ts){
  // admite ISO o epoch
  try {
    const d = typeof ts === "number" ? new Date(ts) : new Date(String(ts));
    if (isNaN(d)) return "";
    return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
  } catch { return ""; }
}
function showStatus(msg, ok=true){
  statusBox.textContent = msg;
  statusBox.className = "status " + (ok ? "ok" : "err");
  statusBox.style.display = "block";
  clearTimeout(showStatus._t);
  showStatus._t = setTimeout(()=>{ statusBox.style.display="none"; }, 3500);
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
}
</script>
</body>
</html>


