<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checador Comida — DL (Multi-líneas)</title>
<style>
  * { box-sizing: border-box; }
  html, body { height:100%; }
  body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0b1220; color:#e5e7eb; display:flex; flex-direction:column; }
  header { padding:14px 16px; background:#0f172a; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  header h1 { font-size:18px; margin:0; font-weight:700; }
  .pill { background:#1d4ed8; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:8px; }
  .wrap { flex:1; display:grid; place-items:center; padding:16px; }
  .card { width:min(1100px, 100%); background:#111827; border:1px solid #1f2937; border-radius:16px; padding:18px; }
  .prompt { font-size:24px; text-align:center; margin:10px 0 16px; color:#f3f4f6; }
  #inp { width:100%; font-size:28px; padding:14px 16px; border-radius:12px; border:1px solid #374151; background:#0b1220; color:#f9fafb; text-align:center; outline:none; letter-spacing:1px; }
  .status { margin-top:16px; padding:16px; border-radius:12px; text-align:center; font-size:20px; font-weight:700; display:none; }
  .ok { background:#052e1f; color:#a7f3d0; border:1px solid #065f46; }
  .err { background:#3b0d0d; color:#fecaca; border:1px solid #7f1d1d; }
  .muted { color:#9ca3af; font-size:12px; }

  .tools { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0 14px; }
  select, button, input[type="date"] { background:#1f2937; color:#e5e7eb; border:1px solid #374151; padding:8px 12px; border-radius:10px; cursor:pointer; }
  input[type="date"] { padding:7px 10px; }

  table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; border:1px solid #1f2937; margin-top:8px;}
  thead th{background:#0f172a; font-weight:700; text-align:left; font-size:14px; padding:10px}
  tbody td{border-top:1px dashed #1f2937; padding:10px; font-size:15px}
  .id{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .time{font-variant-numeric:tabular-nums}
  .right{margin-left:auto}
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="Logo" style="height:40px">
  <h1>Checador DL — Comida <span class="pill">Salida / Regreso</span></h1>
  <div class="right tools">
    <label for="line">Línea:</label>
    <select id="line"></select>

    <label for="fromDate">Desde:</label>
    <input id="fromDate" type="date"/>
    <label for="toDate">Hasta:</label>
    <input id="toDate" type="date"/>
    <button id="todayBtn">Hoy</button>

    <button id="fs">Pantalla completa</button>
    <button id="export">Exportar CSV</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="prompt">Escanea tu tarjeta o escribe tu ID y presiona Enter</div>
    <input id="inp" placeholder="Escanear aquí…" autocomplete="off" inputmode="numeric" />
    <div id="status" class="status"></div>

    <table>
      <thead>
        <tr>
          <th style="width:120px">ID</th>
          <th>Nombre</th>
          <th style="width:150px">Salida</th>
          <th style="width:150px">Regreso</th>
          <th style="width:160px">Total</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="muted" id="loader"></div>
    <div class="muted">Se sincroniza cada 1 segundo con <code>data.json</code>.</div>
  </div>
</div>

<script>
/*** CONFIG ***/
const WORKER_URL   = "https://checador.montoyacarrillojesus6.workers.dev/"; 
const DATA_URL     = "https://raw.githubusercontent.com/jesus578m/checador/main/data.json"; 
const CATALOGO_URL = "catalogo.json"; 
const REMEMBER_LINE_KEY = "dlc:lastLine";
const REMEMBER_FROM_KEY = "dlc:fromDate";
const REMEMBER_TO_KEY   = "dlc:toDate";
const LINES = Array.from({length:12}, (_,i)=>`DL${i+1}`);
const MAX_OK = 70; // minutos tolerancia

/*** UI refs ***/
const selline   = document.getElementById("line");
const fromDate  = document.getElementById("fromDate");
const toDate    = document.getElementById("toDate");
const todayBtn  = document.getElementById("todayBtn");
const inp       = document.getElementById("inp");
const statusBox = document.getElementById("status");
const loader    = document.getElementById("loader");
const btnFS     = document.getElementById("fs");
const btnExport = document.getElementById("export");
const tbody     = document.getElementById("tbody");

/*** State ***/
let catalog = [];
let byId = new Map();
let sessions = [];
let rawData = [];
let pollTimer = null;

/*** Utils ***/
const todayISO = () => new Date().toISOString().slice(0,10);
function setStatus(ok, msg) {
  statusBox.className = "status " + (ok ? "ok" : "err");
  statusBox.textContent = msg;
  statusBox.style.display = "block";
  clearTimeout(setStatus._t);
  setStatus._t = setTimeout(()=>statusBox.style.display="none", 3500);
}
function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
function fmtTime(ts){
  const d = new Date(ts);
  if (isNaN(d)) return "";
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
}
function minsBetween(a,b){ if(!a||!b) return null; return Math.round((new Date(b)-new Date(a))/60000); }
function fmtHM(mins){ if(mins==null) return ""; return String(Math.floor(mins/60)).padStart(2,"0")+":"+String(mins%60).padStart(2,"0"); }

/*** Boot ***/
init();
async function init(){
  selline.innerHTML = LINES.map(l=>`<option value="${l}">${l}</option>`).join("");
  selline.value = localStorage.getItem(REMEMBER_LINE_KEY) || LINES[0];
  fromDate.value = localStorage.getItem(REMEMBER_FROM_KEY) || todayISO();
  toDate.value   = localStorage.getItem(REMEMBER_TO_KEY) || todayISO();

  selline.addEventListener("change", ()=>{ localStorage.setItem(REMEMBER_LINE_KEY, selline.value); render(); });
  fromDate.addEventListener("change", ()=>{ localStorage.setItem(REMEMBER_FROM_KEY, fromDate.value); render(); });
  toDate.addEventListener("change", ()=>{ localStorage.setItem(REMEMBER_TO_KEY, toDate.value); render(); });

  todayBtn.addEventListener("click", ()=>{
    const t = todayISO();
    fromDate.value = t; toDate.value = t;
    localStorage.setItem(REMEMBER_FROM_KEY, t);
    localStorage.setItem(REMEMBER_TO_KEY, t);
    render();
  });

  btnFS.addEventListener("click", ()=>{ if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); });
  btnExport.addEventListener("click", downloadCSV);

  await loadCatalog();
  await refresh();
  pollTimer = setInterval(refresh, 1000);

  inp.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter"){ const raw=(inp.value||"").trim(); inp.value=""; if(raw) handleScan(raw); } });
  inp.focus();
}

/*** Catalog loader ***/
async function loadCatalog(){
  loader.textContent="Cargando catálogo…";
  try{
    const res=await fetch(CATALOGO_URL,{cache:"no-store"});
    const arr=await res.json();
    catalog=arr.map(x=>({employee_id:String(x.CREDENCIAL||x.employee_id||"").trim(), name:String(x.NOMBRE_COMPLETO||x.name||"").trim()})).filter(p=>p.employee_id&&p.name);
    byId.clear(); for(const p of catalog) byId.set(p.employee_id,{name:p.name});
    loader.textContent=`Catálogo cargado: ${catalog.length} empleados.`; setTimeout(()=>loader.textContent="",2500);
  }catch(e){ loader.textContent="Error al cargar catálogo."; }
}

/*** Data refresh ***/
async function refresh(){
  try{
    const res=await fetch(DATA_URL+"?t="+Date.now(),{cache:"no-store"});
    rawData=await res.json();
    sessions=buildSessions(rawData, selline.value, fromDate.value, toDate.value);
    render();
  }catch(e){ setStatus(false,"No se pudo leer data.json"); }
}

/*** Build sessions ***/
function buildSessions(raw,line,from,to){
  const events=[];
  for(const r of raw){
    if(r.timestamp && r.linea===line){
      const dISO=new Date(r.timestamp).toISOString().slice(0,10);
      if(dISO<from||dISO>to) continue;
      const type=String(r.evento).toLowerCase()==="regreso"?"regreso":"salida";
      events.push({ts:r.timestamp,type,id:String(r.employee_id),name:r.nombre||byId.get(r.employee_id)?.name||"",date:dISO});
    }
  }
  const byEmp=new Map();
  for(const e of events){ if(!byEmp.has(e.id)) byEmp.set(e.id,[]); byEmp.get(e.id).push(e); }
  const result=[];
  for(const [id,list] of byEmp){
    list.sort((a,b)=>new Date(a.ts)-new Date(b.ts));
    let open=null;
    for(const e of list){
      if(e.type==="salida"){ if(open) result.push({employee_id:id,name:open.name,date:open.date,out:open.ts,back:null});
        open=e;
      }else{ if(open){ result.push({employee_id:id,name:open.name,date:open.date,out:open.ts,back:e.ts}); open=null; }
             else{ result.push({employee_id:id,name:e.name,date:e.date,out:null,back:e.ts}); }
      }
    }
    if(open) result.push({employee_id:id,name:open.name,date:open.date,out:open.ts,back:null});
  }
  return result.sort((a,b)=>a.name.localeCompare(b.name)||new Date(a.out||a.back)-new Date(b.out||b.back));
}

/*** Render ***/
function render(){
  const rows=sessions;
  if(!rows.length){ tbody.innerHTML=`<tr><td colspan="5" style="text-align:center;opacity:.7">Sin registros para rango</td></tr>`; return; }
  tbody.innerHTML=rows.map(r=>{
    const mins=minsBetween(r.out,r.back);
    const ok=mins!=null?(mins<=MAX_OK):true;
    const total=mins!=null?`${fmtHM(mins)}${ok?"":" ⚠️"}`:"";
    return `<tr>
      <td class="id">${esc(r.employee_id)}</td>
      <td>${esc(r.name)}</td>
      <td class="time">${r.out?fmtTime(r.out):""}</td>
      <td class="time">${r.back?fmtTime(r.back):""}</td>
      <td>${total}</td>
    </tr>`;
  }).join("");
}

/*** Scan handler ***/
async function handleScan(rawId){
  const id=String(rawId).replace(/\D+/g,"");
  if(!id) return setStatus(false,"ID inválido");
  const found=byId.get(id);
  if(!found) return setStatus(false,`No se encontró ${id}`);
  const linea=selline.value;
  const today=todayISO();
  const todaySessions=buildSessions(rawData,linea,today,today).filter(s=>s.employee_id===id);
  let next="salida";
  if(todaySessions.length && todaySessions[todaySessions.length-1].out && !todaySessions[todaySessions.length-1].back) next="regreso";
  const record={linea,employee_id:id,nombre:found.name,evento:next,timestamp:new Date().toISOString()};
  try{
    const put=await fetch(WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"append",record})});
    if(!put.ok) throw new Error();
    setStatus(true,`${next.toUpperCase()} — ${found.name} (${id})`);
    if(fromDate.value!==today||toDate.value!==today){ fromDate.value=today; toDate.value=today; }
    await refresh();
  }catch(e){ setStatus(false,"No se pudo guardar"); }
}

/*** CSV ***/
function downloadCSV(){
  if(!sessions.length) return setStatus(false,"No hay datos");
  const head=["fecha","employee_id","nombre","salida","regreso","total_min"];
  const lines=[head.join(",")];
  for(const r of sessions){
    const mins=minsBetween(r.out,r.back);
    lines.push([r.date,r.employee_id,`"${r.name}"`,r.out||"",r.back||"",mins!=null?mins:""].join(","));
  }
  const blob=new Blob([lines.join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=`checador_${fromDate.value}_${toDate.value}_${selline.value}.csv`; a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>



