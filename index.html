<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checador Comida — DL (Multi-líneas)</title>
<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e5e7eb;display:flex;flex-direction:column}
  header{padding:14px 16px;background:#0f172a;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  header h1{font-size:18px;margin:0;font-weight:700}
  .pill{background:#1d4ed8;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
  .wrap{flex:1;display:grid;place-items:center;padding:16px}
  .card{width:min(760px,100%);background:#111827;border:1px solid #1f2937;border-radius:16px;padding:18px}
  .group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,button{background:#1f2937;color:#e5e7eb;border:1px solid #374151;padding:8px 12px;border-radius:10px;cursor:pointer}
  .prompt{font-size:22px;text-align:center;margin:10px 0 12px;color:#f3f4f6}
  #inp{width:100%;font-size:28px;padding:14px 16px;border-radius:12px;border:1px solid #374151;background:#0b1220;color:#f9fafb;text-align:center;outline:none}
  .status{margin-top:12px;padding:12px;border-radius:12px;text-align:center;font-size:18px;font-weight:700;display:none}
  .ok{background:#052e1f;color:#a7f3d0;border:1px solid #065f46}
  .err{background:#3b0d0d;color:#fecaca;border:1px solid #7f1d1d}
  .list{margin-top:14px;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px;max-height:300px;overflow:auto}
  .row{display:flex;justify-content:space-between;gap:10px;padding:6px 4px;border-bottom:1px dashed #1f2937;font-size:14px}
  .row:last-child{border-bottom:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .logo{height:40px}
</style>
</head>
<body>
<header>
  <img src="logo.png" class="logo" alt="Logo">
  <h1>Checador DL — Comida <span class="pill">Salida / Regreso</span></h1>
  <div style="margin-left:auto" class="group">
    <label for="line">Línea:</label>
    <select id="line"></select>
    <button id="fs">Pantalla completa</button>
    <button id="export">Exportar CSV</button>
    <button id="clear">Borrar hoy</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="prompt">Escanea tu tarjeta o escribe tu ID y presiona Enter</div>
    <input id="inp" placeholder="Escanear aquí…" autocomplete="off" />
    <div id="status" class="status"></div>
    <div class="list" id="recent"></div>
  </div>
</div>

<script>
/*** CONFIG ***/
const WORKER_URL = "https://checador.montoyacarrillojesus6.workers.dev"; // <— cambia si usas otro
const CATALOG_URL = "catalogo.json"; // Debe existir en la misma carpeta
const REMEMBER_LINE_KEY = "dlc:lastLine";
const LINES = Array.from({length:12}, (_,i)=>`DL${i+1}`);

/*** UI refs ***/
const selLine = document.getElementById("line");
const inp = document.getElementById("inp");
const statusEl = document.getElementById("status");
const recentEl = document.getElementById("recent");

/*** Estado ***/
let CATALOG = [];           // {employee_id, name}
let ALL = [];               // registros completos desde data.json
let CURRENT_LINE = "DL1";

/*** Fechas (hora local MX) ***/
const tz = "America/Mexico_City";
const fmtTime = new Intl.DateTimeFormat("es-MX",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false,timeZone:tz});
function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
function nowHM(){ return fmtTime.format(new Date()); }

/*** Helpers de red con el Worker ***/
async function loadAll(){
  const r = await fetch(WORKER_URL, { cache:"no-store" });
  if (!r.ok) throw new Error("No se pudo leer datos del Worker");
  const j = await r.json();
  ALL = Array.isArray(j) ? j : [];
}
async function appendRecord(rec){
  const r = await fetch(WORKER_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action:"append", record: rec })
  });
  const j = await r.json().catch(()=>({ok:false}));
  if (!r.ok || !j.ok) throw new Error("No se pudo guardar (append)");
}
async function replaceAll(newArray){
  const r = await fetch(WORKER_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action:"replace", data: newArray })
  });
  const j = await r.json().catch(()=>({ok:false}));
  if (!r.ok || !j.ok) throw new Error("No se pudo guardar (replace)");
}

/*** Catalogo ***/
async function loadCatalog(){
  // Carga desde catalogo.json
  const r = await fetch(CATALOG_URL, { cache:"no-store" });
  if (!r.ok) throw new Error("No pude cargar catalogo.json");
  const arr = await r.json();
  if (!Array.isArray(arr)) throw new Error("catalogo.json no es un arreglo");
  // Normaliza a {employee_id:String, name:String}
  CATALOG = arr.map(x => ({
    employee_id: String(x.CREDENCIAL ?? x.employee_id ?? "").trim(),
    name: String(x.NOMBRE_COMPLETO ?? x.name ?? "").trim()
  })).filter(x => x.employee_id && x.name);
}

/*** UI: líneas ***/
function populateLines(){
  selLine.innerHTML = LINES.map(l=>`<option value="${l}">${l}</option>`).join("");
  const urlLine = new URL(location.href).searchParams.get("line");
  const saved = localStorage.getItem(REMEMBER_LINE_KEY);
  const start = (urlLine && LINES.includes(urlLine)) ? urlLine :
                (saved && LINES.includes(saved)) ? saved : "DL1";
  selLine.value = start;
  CURRENT_LINE = selLine.value;
  localStorage.setItem(REMEMBER_LINE_KEY, CURRENT_LINE);
}
selLine.addEventListener("change", ()=>{
  CURRENT_LINE = selLine.value;
  localStorage.setItem(REMEMBER_LINE_KEY, CURRENT_LINE);
  renderRecent();
});

/*** Mensajes ***/
function flashOK(msg){ statusEl.className="status ok"; statusEl.textContent=msg; statusEl.style.display="block"; setTimeout(()=>statusEl.style.display="none", 2000); }
function flashERR(msg){ statusEl.className="status err"; statusEl.textContent=msg; statusEl.style.display="block"; setTimeout(()=>statusEl.style.display="none", 3000); }

/*** Render lista de hoy por línea ***/
function renderRecent(){
  const hoy = todayISO();
  const rows = ALL
    .filter(r => r.linea===CURRENT_LINE && r.fecha===hoy)
    .slice(-100).reverse()
    .map(r => `
      <div class="row">
        <div class="mono">${r.employee_id}</div>
        <div>${r.name}</div>
        <div>Salida: <b>${r.salida_comida||"-"}</b></div>
        <div>Regreso: <b>${r.regreso_comida||"-"}</b></div>
        <div>${r.duracion_minutos!=null ? r.duracion_minutos+" min" : "-"}</div>
      </div>
    `).join("");
  recentEl.innerHTML = rows || `<div class="row"><em>Sin registros hoy en ${CURRENT_LINE}</em></div>`;
}

/*** Buscar en catálogo ***/
function findEmployeeById(id){
  const key = String(id).trim();
  // búsqueda exacta por credencial
  return CATALOG.find(x => x.employee_id === key) || null;
}

/*** Lógica toggle Salida/Regreso ***/
async function toggleMark(emp){
  const hoy = todayISO();
  const now = nowHM();

  // buscar último registro de hoy para ese empleado/linea
  let lastIdx = -1;
  for (let i=ALL.length-1; i>=0; i--){
    const r = ALL[i];
    if (r.linea===CURRENT_LINE && r.employee_id===emp.employee_id && r.fecha===hoy){
      lastIdx = i; break;
    }
  }

  if (lastIdx >= 0){
    const last = ALL[lastIdx];
    if (last.salida_comida && !last.regreso_comida){
      // cerrar con regreso
      const minutes = (()=> {
        try{
          const [h1,m1] = last.salida_comida.split(":").map(Number);
          const [h2,m2] = now.split(":").map(Number);
          return Math.max(0, (h2*60+m2)-(h1*60+m1));
        }catch{ return null; }
      })();
      const updated = { ...last, regreso_comida: now, duracion_minutos: minutes };
      const newAll = ALL.slice();
      newAll[lastIdx] = updated;
      await replaceAll(newAll);
      ALL = newAll;
      flashOK(`✔ Regreso de ${emp.name} — ${now}`);
      return;
    }
  }

  // crear nueva salida
  const nuevo = {
    linea: CURRENT_LINE,
    employee_id: emp.employee_id,
    name: emp.name,
    fecha: hoy,
    salida_comida: now,
    regreso_comida: null,
    duracion_minutos: null
  };
  await appendRecord(nuevo);
  ALL.push(nuevo);
  flashOK(`✔ Salida de ${emp.name} — ${now}`);
}

/*** Input (lector/Enter) ***/
inp.addEventListener("keydown", async (ev)=>{
  if (ev.key !== "Enter") return;
  const raw = inp.value.trim();
  inp.value = "";
  if (!raw) return;

  try{
    // refresca estado para evitar choques
    await loadAll();
    const emp = findEmployeeById(raw);
    if (!emp){ flashERR(`ID ${raw} no encontrado`); return; }
    await toggleMark(emp);
    renderRecent();
  }catch(err){
    console.error(err);
    flashERR("Error al guardar. Reintenta.");
  }
});

/*** Exportar CSV del día/linea ***/
document.getElementById("export").addEventListener("click", ()=>{
  const hoy = todayISO();
  const data = ALL.filter(r => r.linea===CURRENT_LINE && r.fecha===hoy);
  const csv = ["linea,employee_id,name,fecha,salida,regreso,duracion_min"];
  for (const r of data){
    csv.push([
      r.linea, r.employee_id, quote(r.name),
      r.fecha, r.salida_comida||"", r.regreso_comida||"",
      (r.duracion_minutos ?? "")
    ].map(v=>String(v)).join(","));
  }
  const blob = new Blob([csv.join("\n")],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `checador_${CURRENT_LINE}_${hoy}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
});
function quote(s){ return `"${String(s).replace(/"/g,'""')}"`; }

/*** Borrar registros de HOY de la línea actual ***/
document.getElementById("clear").addEventListener("click", async ()=>{
  if (!confirm(`¿Borrar registros de hoy para ${CURRENT_LINE}?`)) return;
  const hoy = todayISO();
  const keep = ALL.filter(r => !(r.linea===CURRENT_LINE && r.fecha===hoy));
  try{
    await replaceAll(keep);
    ALL = keep;
    renderRecent();
    flashOK("Registros borrados (solo de hoy y esta línea).");
  }catch{ flashERR("No se pudo borrar."); }
});

/*** Pantalla completa ***/
document.getElementById("fs").addEventListener("click", ()=>{
  if (document.fullscreenElement) document.exitFullscreen();
  else document.documentElement.requestFullscreen().catch(()=>{});
});

/*** Init ***/
(async function init(){
  populateLines();
  try{
    await loadCatalog();
  }catch(e){
    console.error(e);
    flashERR("No pude cargar catalogo.json");
  }
  try{
    await loadAll();
  }catch(e){
    console.error(e);
    ALL = [];
  }
  renderRecent();
  // autofocus para lector
  setTimeout(()=>inp.focus(), 100);
})();
</script>
</body>
</html>
