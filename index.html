<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checador Comida — DL (Multi-líneas)</title>
<style>
  * { box-sizing: border-box; }
  html, body { height:100%; }
  body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0b1220; color:#e5e7eb; display:flex; flex-direction:column; }
  header { padding:14px 16px; background:#0f172a; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  header h1 { font-size:18px; margin:0; font-weight:700; }
  .pill { background:#1d4ed8; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:8px; }
  .wrap { flex:1; display:grid; place-items:center; padding:16px; }
  .card { width:min(1000px, 100%); background:#111827; border:1px solid #1f2937; border-radius:16px; padding:18px; }
  .prompt { font-size:24px; text-align:center; margin:10px 0 16px; color:#f3f4f6; }
  #inp { width:100%; font-size:28px; padding:14px 16px; border-radius:12px; border:1px solid #374151; background:#0b1220; color:#f9fafb; text-align:center; outline:none; letter-spacing:1px; }
  .status { margin-top:16px; padding:16px; border-radius:12px; text-align:center; font-size:20px; font-weight:700; display:none; }
  .ok { background:#052e1f; color:#a7f3d0; border:1px solid #065f46; }
  .err { background:#3b0d0d; color:#fecaca; border:1px solid #7f1d1d; }
  .muted { color:#9ca3af; font-size:12px; }

  .tools { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0 14px; }
  select, button { background:#1f2937; color:#e5e7eb; border:1px solid #374151; padding:8px 12px; border-radius:10px; cursor:pointer; }

  table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; border:1px solid #1f2937; margin-top:8px;}
  thead th{background:#0f172a; font-weight:700; text-align:left; font-size:14px; padding:10px}
  tbody td{border-top:1px dashed #1f2937; padding:10px; font-size:15px}
  .id{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .time{font-variant-numeric:tabular-nums}
  .right{margin-left:auto}
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="Logo" style="height:40px">
  <h1>Checador DL — Comida <span class="pill">Salida / Regreso</span></h1>
  <div class="right tools">
    <label for="line">Línea:</label>
    <select id="line"></select>
    <button id="fs">Pantalla completa</button>
    <button id="export">Exportar CSV</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="prompt">Escanea tu tarjeta o escribe tu ID y presiona Enter</div>
    <input id="inp" placeholder="Escanear aquí…" autocomplete="off" inputmode="numeric" />
    <div id="status" class="status"></div>

    <table>
      <thead>
        <tr>
          <th style="width:120px">ID</th>
          <th>Nombre</th>
          <th style="width:150px">Salida</th>
          <th style="width:150px">Regreso</th>
          <th style="width:160px">Total</th> <!-- NUEVO -->
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="muted" id="loader"></div>
    <div class="muted">Se sincroniza cada 1 segundos con <code>data.json</code>.</div>
  </div>
</div>

<script>
/*** CONFIG ***/
const WORKER_URL   = "https://checador.montoyacarrillojesus6.workers.dev/"; 
const DATA_URL     = "https://raw.githubusercontent.com/jesus578m/checador/main/data.json"; 
const CATALOGO_URL = "catalogo.json"; 
const REMEMBER_LINE_KEY = "dlc:lastLine";
const LAST_EVENT_KEY_PREFIX = "dlc:lastEvent:"; 
const LINES = Array.from({length:12}, (_,i)=>`DL${i+1}`);

// --- configuración de tolerancia ---
const MAX_OK = 70; // alerta solo si es MAYOR a 70 min

/*** UI refs ***/
const selline   = document.getElementById("line");
const inp       = document.getElementById("inp");
const statusBox = document.getElementById("status");
const loader    = document.getElementById("loader");
const btnFS     = document.getElementById("fs");
const btnExport = document.getElementById("export");
const tbody     = document.getElementById("tbody");

/*** State ***/
let catalog = [];           
let byId = new Map();       
let tableRows = [];         
let lastEventLocal = {};    
let pollTimer = null;

/*** Utils ***/
const todayISO = () => new Date().toISOString().slice(0,10);
const LEKey = () => LAST_EVENT_KEY_PREFIX + todayISO();

function setStatus(ok, msg) {
  statusBox.className = "status " + (ok ? "ok" : "err");
  statusBox.textContent = msg;
  statusBox.style.display = "block";
  clearTimeout(setStatus._t);
  setStatus._t = setTimeout(()=>statusBox.style.display="none", 3500);
}
function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
function fmtTime(ts){
  try {
    const d = typeof ts === "number" ? new Date(ts) : new Date(String(ts));
    if (isNaN(d)) return "";
    return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
  } catch { return ""; }
}
function minsBetween(a, b){
  if(!a || !b) return null;
  const t1 = +new Date(a), t2 = +new Date(b);
  if(isNaN(t1) || isNaN(t2)) return null;
  return Math.round((t2 - t1) / 60000);
}
function fmtHM(mins){
  if(mins == null) return "";
  const h = Math.floor(mins/60), m = mins % 60;
  return String(h).padStart(2,'0') + ":" + String(m).padStart(2,'0');
}

/*** Boot ***/
init();
async function init(){
  selline.innerHTML = LINES.map(l=>`<option value="${l}">${l}</option>`).join("");
  const remembered = localStorage.getItem(REMEMBER_LINE_KEY);
  selline.value = (remembered && LINES.includes(remembered)) ? remembered : LINES[0];
  selline.addEventListener("change", ()=>{ localStorage.setItem(REMEMBER_LINE_KEY, selline.value); render(); });

  btnFS.addEventListener("click", () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  });
  btnExport.addEventListener("click", downloadCSV);

  try { lastEventLocal = JSON.parse(localStorage.getItem(LEKey())||"{}"); } catch { lastEventLocal = {}; }

  await loadCatalog();
  await refresh();
  pollTimer = setInterval(refresh, 1000);

  inp.addEventListener("keydown", (ev)=>{
    if (ev.key === "Enter") {
      const raw = (inp.value||"").trim(); inp.value = "";
      if (raw) handleScan(raw);
    }
  });
  inp.focus();
}

/*** Catalog loader ***/
async function loadCatalog() {
  loader.textContent = "Cargando catálogo…";
  try {
    const res = await fetch(CATALOGO_URL, { cache: "no-store" });
    const arr = await res.json();
    catalog = (Array.isArray(arr) ? arr : []).map(x => ({
      employee_id: String(x.CREDENCIAL ?? x.employee_id ?? "").trim(),
      name: String(x.NOMBRE_COMPLETO ?? x.name ?? "").trim()
    })).filter(p=>p.employee_id && p.name);
    byId.clear();
    for (const p of catalog) byId.set(p.employee_id, { name: p.name });
    loader.textContent = `Catálogo cargado: ${catalog.length} empleados.`;
    setTimeout(()=>loader.textContent="", 2500);
  } catch (e) {
    console.error(e);
    loader.textContent = "No se pudo cargar el catálogo.";
    setStatus(false, "Error al cargar catálogo");
  }
}

/*** Data refresh ***/
async function refresh() {
  try {
    const res = await fetch(DATA_URL + "?_=" + Date.now(), { cache: "no-store" });
    const text = await res.text();
    const json = JSON.parse(text || "[]");
    tableRows = consolidateToday(json, selline.value);
    render();
  } catch (e) {
    console.error("No se pudo leer data.json", e);
    setStatus(false, "No se pudo leer data.json");
  }
}

/*** Consolidación ***/
function consolidateToday(raw, line) {
  const today = todayISO();
  const map = new Map();

  for (const r of Array.isArray(raw) ? raw : []) {
    if (r && r.date && r.linea && r.employee_id) {
      if (r.date !== today || r.linea !== line) continue;
      const id = String(r.employee_id);
      const name = String(r.name || byId.get(id)?.name || "");
      const row = map.get(id) || { employee_id:id, name, linea:line, date:today, out:null, back:null };
      if (r.out)  row.out  = r.out;
      if (r.back) row.back = r.back;
      map.set(id, row);
      continue;
    }
    if (r && r.timestamp && r.linea && r.employee_id && r.evento) {
      const d = new Date(r.timestamp);
      const dISO = isNaN(d)? null : d.toISOString().slice(0,10);
      if (dISO !== today || r.linea !== line) continue;
      const id = String(r.employee_id);
      const name = String(r.nombre || r.name || byId.get(id)?.name || "");
      const row = map.get(id) || { employee_id:id, name, linea:line, date:today, out:null, back:null };
      if (String(r.evento).toLowerCase() === "salida")  row.out  = r.timestamp;
      if (String(r.evento).toLowerCase() === "regreso") row.back = r.timestamp;
      map.set(id, row);
    }
  }
  return Array.from(map.values()).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
}

/*** Render tabla ***/
function render() {
  const rows = tableRows;
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="5" style="opacity:.7; text-align:center; padding:14px">
      No hay registros para hoy en <b>${esc(selline.value)}</b>.
    </td></tr>`;
    return;
  }
  tbody.innerHTML = rows.map(r=>{
    const mins = minsBetween(r.out, r.back);
    const ok = mins!=null ? (mins <= MAX_OK) : true;
    const total = mins!=null
      ? `<span class="time" title="${mins} min">${fmtHM(mins)}${ok ? "" : " ⚠️"}</span>`
      : "";
    return `
      <tr>
        <td class="id">${esc(r.employee_id)}</td>
        <td>${esc(r.name||"")}</td>
        <td class="time">${r.out ? fmtTime(r.out) : ""}</td>
        <td class="time">${r.back ? fmtTime(r.back) : ""}</td>
        <td>${total}</td>
      </tr>
    `;
  }).join("");
}

/*** Escaneo / alta ***/
async function handleScan(rawId) {
  const id = String(rawId).replace(/\D+/g,"");
  if (!id) { setStatus(false, "ID inválido"); return; }

  const found = byId.get(id);
  if (!found) { setStatus(false, `No se encontró el ID ${id}`); return; }

  const nombre = found.name || "SIN NOMBRE";
  const linea = selline.value;

  const row = tableRows.find(r => r.employee_id === id);
  let nextEvento;
  if (row && row.out && !row.back) nextEvento = "regreso";
  else nextEvento = "salida";
  if (!row && lastEventLocal[id] === "salida") nextEvento = "regreso";

  const record = { linea, employee_id: id, nombre, evento: nextEvento, timestamp: new Date().toISOString() };

  try {
    const put = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "append", record })
    });
    if (!put.ok) throw new Error("Worker " + put.status);
    lastEventLocal[id] = nextEvento;
    localStorage.setItem(LEKey(), JSON.stringify(lastEventLocal));
    setStatus(true, `${nextEvento.toUpperCase()} — ${nombre} (${id})`);
    await refresh();
  } catch (err) {
    console.error(err);
    setStatus(false, "No se pudo guardar. Reintenta.");
  }
}

/*** CSV ***/
function downloadCSV(){
  const rows = tableRows;
  if (!rows.length) { setStatus(false, "No hay registros para exportar"); return; }
  const head = ["fecha","linea","employee_id","nombre","salida","regreso","total_min"];
  const lines = [head.join(",")];
  for (const r of rows) {
    const mins = minsBetween(r.out, r.back);
    const row = [
      r.date, r.linea, r.employee_id,
      `"${String(r.name||"").replace(/"/g,'""')}"`,
      r.out ? fmtTime(r.out) : "", r.back ? fmtTime(r.back) : "",
      mins!=null ? mins : ""
    ];
    lines.push(row.join(","));
  }
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `checador_${todayISO()}_${selline.value}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>


